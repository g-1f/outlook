{"version":3,"sources":["useActiveDescendant.ts"],"sourcesContent":["import * as React from 'react';\nimport { useEventCallback, useMergedRefs } from '@fluentui/react-utilities';\nimport { useOnKeyboardNavigationChange } from '@fluentui/react-tabster';\nimport { useOptionWalker } from './useOptionWalker';\nimport type { ActiveDescendantImperativeRef, ActiveDescendantOptions, UseActiveDescendantReturn } from './types';\nimport { ACTIVEDESCENDANT_ATTRIBUTE, ACTIVEDESCENDANT_FOCUSVISIBLE_ATTRIBUTE } from './constants';\nimport { scrollIntoView } from './scrollIntoView';\n\nexport function useActiveDescendant<TActiveParentElement extends HTMLElement, TListboxElement extends HTMLElement>(\n  options: ActiveDescendantOptions,\n): UseActiveDescendantReturn<TActiveParentElement, TListboxElement> {\n  const { imperativeRef, matchOption: matchOptionUnstable } = options;\n  const focusVisibleRef = React.useRef(false);\n  const activeIdRef = React.useRef<string | null>(null);\n  const activeParentRef = React.useRef<TActiveParentElement>(null);\n\n  useOnKeyboardNavigationChange(isNavigatingWithKeyboard => {\n    focusVisibleRef.current = isNavigatingWithKeyboard;\n    const active = getActiveDescendant();\n    if (!active) {\n      return;\n    }\n\n    if (isNavigatingWithKeyboard) {\n      active.setAttribute(ACTIVEDESCENDANT_FOCUSVISIBLE_ATTRIBUTE, '');\n    } else {\n      active.removeAttribute(ACTIVEDESCENDANT_FOCUSVISIBLE_ATTRIBUTE);\n    }\n  });\n\n  const matchOption = useEventCallback(matchOptionUnstable);\n  const listboxRef = React.useRef<TListboxElement>(null);\n  const { optionWalker, listboxCallbackRef } = useOptionWalker<TListboxElement>({ matchOption });\n  const getActiveDescendant = React.useCallback(() => {\n    return listboxRef.current?.querySelector<HTMLElement>(`#${activeIdRef.current}`);\n  }, [listboxRef]);\n\n  const blurActiveDescendant = React.useCallback(() => {\n    const active = getActiveDescendant();\n    if (active) {\n      active.removeAttribute(ACTIVEDESCENDANT_ATTRIBUTE);\n      active.removeAttribute(ACTIVEDESCENDANT_FOCUSVISIBLE_ATTRIBUTE);\n    }\n\n    activeParentRef.current?.removeAttribute('aria-activedescendant');\n    activeIdRef.current = null;\n  }, [activeParentRef, getActiveDescendant]);\n\n  const focusActiveDescendant = React.useCallback(\n    (nextActive: HTMLElement | null) => {\n      if (!nextActive) {\n        return;\n      }\n\n      blurActiveDescendant();\n\n      scrollIntoView(nextActive, listboxRef.current);\n      activeParentRef.current?.setAttribute('aria-activedescendant', nextActive.id);\n      activeIdRef.current = nextActive.id;\n      nextActive.setAttribute(ACTIVEDESCENDANT_ATTRIBUTE, '');\n\n      if (focusVisibleRef.current) {\n        nextActive.setAttribute(ACTIVEDESCENDANT_FOCUSVISIBLE_ATTRIBUTE, '');\n      }\n    },\n    [activeParentRef, listboxRef, blurActiveDescendant],\n  );\n\n  const controller: ActiveDescendantImperativeRef = React.useMemo(\n    () => ({\n      first: ({ passive } = {}) => {\n        const first = optionWalker.first();\n        if (!passive) {\n          focusActiveDescendant(first);\n        }\n\n        return first?.id;\n      },\n      last: ({ passive } = {}) => {\n        const last = optionWalker.last();\n        if (!passive) {\n          focusActiveDescendant(last);\n        }\n\n        return last?.id;\n      },\n      next: ({ passive } = {}) => {\n        const active = getActiveDescendant();\n        if (!active) {\n          return;\n        }\n\n        optionWalker.setCurrent(active);\n        const next = optionWalker.next();\n        if (!passive) {\n          focusActiveDescendant(next);\n        }\n\n        return next?.id;\n      },\n      prev: ({ passive } = {}) => {\n        const active = getActiveDescendant();\n        if (!active) {\n          return;\n        }\n\n        optionWalker.setCurrent(active);\n        const next = optionWalker.prev();\n\n        if (!passive) {\n          focusActiveDescendant(next);\n        }\n\n        return next?.id;\n      },\n      blur: () => {\n        blurActiveDescendant();\n      },\n      active: () => {\n        return getActiveDescendant()?.id;\n      },\n\n      focus: (id: string) => {\n        if (!listboxRef.current) {\n          return;\n        }\n\n        const target = listboxRef.current.querySelector<HTMLElement>(`#${id}`);\n        if (target) {\n          focusActiveDescendant(target);\n        }\n      },\n\n      find(predicate, { passive, startFrom } = {}) {\n        const target = optionWalker.find(predicate, startFrom);\n        if (!passive) {\n          focusActiveDescendant(target);\n        }\n\n        return target?.id;\n      },\n    }),\n    [optionWalker, listboxRef, focusActiveDescendant, blurActiveDescendant, getActiveDescendant],\n  );\n\n  React.useImperativeHandle(imperativeRef, () => controller);\n\n  return { listboxRef: useMergedRefs(listboxRef, listboxCallbackRef), activeParentRef, controller };\n}\n"],"names":["React","useEventCallback","useMergedRefs","useOnKeyboardNavigationChange","useOptionWalker","ACTIVEDESCENDANT_ATTRIBUTE","ACTIVEDESCENDANT_FOCUSVISIBLE_ATTRIBUTE","scrollIntoView","useActiveDescendant","options","imperativeRef","matchOption","matchOptionUnstable","focusVisibleRef","useRef","activeIdRef","activeParentRef","isNavigatingWithKeyboard","current","active","getActiveDescendant","setAttribute","removeAttribute","listboxRef","optionWalker","listboxCallbackRef","useCallback","querySelector","blurActiveDescendant","focusActiveDescendant","nextActive","id","controller","useMemo","first","passive","last","next","setCurrent","prev","blur","focus","target","find","predicate","startFrom","useImperativeHandle"],"mappings":"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"}